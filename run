#!/bin/bash
# Comprehensive HMS stack runner: builds and runs everything with proper configuration
set -e

cd "$(dirname "$0")"

echo "ðŸ¥ Starting Hospital Management System..."

# Stop all running containers
echo "ðŸ“ Stopping existing containers..."
sudo docker-compose down 2>/dev/null || true

# Kill any processes on ports 8080 and 3000
echo "ðŸ”§ Freeing up ports 8080 and 3000..."
sudo lsof -ti:8080 | xargs sudo kill -9 2>/dev/null || true
sudo lsof -ti:3000 | xargs sudo kill -9 2>/dev/null || true

# Build the backend with H2 database
echo "ðŸ”¨ Building backend..."
./mvnw clean package -DskipTests

# Start backend with H2 database in background
echo "ðŸš€ Starting backend on port 8080 with H2 database..."
nohup java -jar target/hms-0.0.1-SNAPSHOT.jar --spring.profiles.active=dev > backend.log 2>&1 &
BACKEND_PID=$!
echo "Backend PID: $BACKEND_PID"

# Wait for backend to be responsive (check API docs instead of health which can fail due to mail)
echo "â³ Waiting for backend to be ready..."
for i in {1..30}; do
  if curl -sf http://localhost:8080/api-docs > /dev/null 2>&1; then
    echo "âœ… Backend is responding!"
    break
  fi
  if [ $i -eq 30 ]; then
    echo "âŒ Backend failed to start after 30 attempts"
    echo "Backend logs:"
    tail -20 backend.log
    exit 1
  fi
  echo "  Attempt $i/30 - waiting for backend..."
  sleep 2
done

# Start frontend
echo "ðŸŽ¨ Starting frontend on port 3000..."
cd frontend
npm install > /dev/null 2>&1
echo "âœ… Frontend dependencies installed"
echo "ðŸ—ï¸  Building frontend for production..."
npm run build
echo "âœ… Frontend built successfully"
PORT=3000 nohup npm run preview -- --host 0.0.0.0 --port 3000 > frontend.log 2>&1 &
FRONTEND_PID=$!
echo "Frontend PID: $FRONTEND_PID"
cd ..

# Wait for frontend to be ready
echo "â³ Waiting for frontend to be ready..."
for i in {1..15}; do
  if curl -sf http://localhost:3000 > /dev/null 2>&1; then
    echo "âœ… Frontend is ready!"
    break
  fi
  if [ $i -eq 15 ]; then
    echo "âš ï¸  Frontend might still be starting..."
    break
  fi
  echo "  Attempt $i/15 - waiting for frontend..."
  sleep 2
done

echo "
ðŸŽ‰ HMS Application is now running successfully!

ðŸ“Š Backend API:  http://localhost:8080
   - API Documentation: http://localhost:8080/swagger-ui.html
   - H2 Database Console: http://localhost:8080/h2-console
     (URL: jdbc:h2:mem:testdb, User: sa, Password: [empty])

ðŸ–¥ï¸  Frontend UI:  http://localhost:3000

ï¿½ Key Features Available:
   - OPD Management (Patients, Appointments, Consultations)
   - IPD Management (Admissions, Wards, Beds, Vitals)
   - Pharmacy Management (Medicines, Sales, Returns)
   - Billing & Payments
   - User Management & Authentication

ï¿½ðŸ“ Application Logs:
   - Backend: tail -f backend.log
   - Frontend: Check terminal output

ðŸ›‘ To stop the application:
   - Use: ./stop
   - Or manually: kill $BACKEND_PID $FRONTEND_PID
"

# Save PIDs for the stop script
echo "$BACKEND_PID" > .backend_pid
echo "$FRONTEND_PID" > .frontend_pid
